# Static configuration - Traefik v3
# Updated configuration with ServersTransport for mail services
# and enhanced security features

global:
  checkNewVersion: true
  sendAnonymousUsage: false

# Entry Points Configuration
entryPoints:
  # HTTP Entry Point (redirect to HTTPS)
  web:
    address: ":80"
    http3: {}
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true
    forwardedHeaders:
      trustedIPs:
        # IPv4 Cloudflare ranges
        - "173.245.48.0/20"
        - "103.21.244.0/22"
        - "103.22.200.0/22"
        - "103.31.4.0/22"
        - "141.101.64.0/18"
        - "108.162.192.0/18"
        - "190.93.240.0/20"
        - "188.114.96.0/20"
        - "197.234.240.0/22"
        - "198.41.128.0/17"
        - "162.158.0.0/15"
        - "104.16.0.0/13"
        - "104.24.0.0/14"
        - "172.64.0.0/13"
        - "131.0.72.0/22"
        # IPv6 Cloudflare ranges
        - "2400:cb00::/32"
        - "2606:4700::/32"
        - "2803:f800::/32"
        - "2405:b500::/32"
        - "2405:8100::/32"
        - "2a06:98c0::/29"
        - "2c0f:f248::/32"

  # HTTPS Entry Point
  websecure:
    address: ":443"
    http3: {}
    forwardedHeaders:
      trustedIPs:
        # IPv4 Cloudflare ranges
        - "173.245.48.0/20"
        - "103.21.244.0/22"
        - "103.22.200.0/22"
        - "103.31.4.0/22"
        - "141.101.64.0/18"
        - "108.162.192.0/18"
        - "190.93.240.0/20"
        - "188.114.96.0/20"
        - "197.234.240.0/22"
        - "198.41.128.0/17"
        - "162.158.0.0/15"
        - "104.16.0.0/13"
        - "104.24.0.0/14"
        - "172.64.0.0/13"
        - "131.0.72.0/22"
        # IPv6 Cloudflare ranges
        - "2400:cb00::/32"
        - "2606:4700::/32"
        - "2803:f800::/32"
        - "2405:b500::/32"
        - "2405:8100::/32"
        - "2a06:98c0::/29"
        - "2c0f:f248::/32"
    http:
      tls:
        certResolver: cloudflare
        options: modern@file

# TCP Router Configuration for SSH
tcp:
  routers:
    ssh-router:
      entryPoints:
        - "ssh"
      rule: "HostSNI(`*`)"
      service: ssh-service

# Certificate Resolvers
certificatesResolvers:
  cloudflare:
    acme:
      keyType: EC256
      email: "admin@example.com"
      storage: /acme/acme.json
      dnsChallenge:
        provider: cloudflare
        resolvers:
          - "1.1.1.1:53"
          - "1.0.0.1:53"
        propagation:
          delayBeforeChecks: 30s

# Providers Configuration
providers:
  # Docker provider for container auto-discovery
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: traefik-net
    watch: true

  # File provider for dynamic configuration
  file:
    directory: "/dynamic"
    watch: true

# TLS Configuration
tls:
  options:
    default:
      minVersion: VersionTLS13
      sniStrict: true
      cipherSuites:
        - TLS_AES_256_GCM_SHA384
        - TLS_AES_128_GCM_SHA256
        - TLS_CHACHA20_POLY1305_SHA256

# API and Dashboard Configuration
api:
  dashboard: true
  insecure: false
  debug: false

# Logging Configuration
log:
  level: "INFO"
  format: "json"
#  filePath: "/logs/traefik.log"

# Access Log Configuration
accessLog:
  filePath: "/logs/access.log"
  format: json
  filters:
    statusCodes:
      - "200"
      - "300-302"
      - "400-499"
      - "500-599"
    retryAttempts: true
    minDuration: "10ms"

# Metrics Configuration (optional but recommended)
metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
    addRoutersLabels: true

# Global HTTP/3 Configuration
http3:
  advertisedPort: 443
